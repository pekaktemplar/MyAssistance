<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Penjadwalan Asistensi Medis</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS (js-xlsx) for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, doc, getDoc, onSnapshot, addDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDuTJS9cOyxdk_YJ1KX9BqGCPu-z-A32Y0",
        authDomain: "myassistance-4ed30.firebaseapp.com",
        projectId: "myassistance-4ed30",
        storageBucket: "myassistance-4ed30.appspot.com",
        messagingSenderId: "520039870795",
        appId: "1:520039870795:web:dceece63843d1bcd1ff8ce"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      
      // Make auth and db globally available for other parts of the script
      window.firebase = { auth, db, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, collection, doc, getDoc, onSnapshot, addDoc, setDoc, deleteDoc };
    </script>

    <style>
        :root {
            --color-primary: #194e91;
            --color-secondary: #d0ad5f;
            --color-accent: #b68103;
            --color-bg-light: #fefdfc;
            --color-bg-subtle: #e9d9b0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-light);
            color: #334155;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: var(--color-bg-subtle); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-secondary); }
        .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .modal.hidden { opacity: 0; visibility: hidden; }
        .modal.hidden .modal-content { transform: scale(0.95); opacity: 0; }
        .officer-row:not(:last-child) { border-bottom: 1px dashed #d1d5db; padding-bottom: 1rem; margin-bottom: 1rem; }
        .form-input:focus, .form-select:focus, .form-checkbox:focus { --tw-ring-color: var(--color-secondary); border-color: var(--color-secondary); }
        .btn { transition: all 0.3s ease-in-out; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(0px) scale(0.98); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        
        #login-overlay.hidden { display: none; }
        #app-content.hidden { display: none; }
    </style>
</head>
<body class="antialiased">

    <!-- Login Screen -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="text-center p-8 bg-white shadow-xl rounded-2xl max-w-sm w-full mx-4">
            <h1 class="text-2xl font-bold text-[--color-primary]">Selamat Datang</h1>
            <p class="text-slate-500 mt-2 mb-8">Silakan masuk untuk mengakses dashboard.</p>
            <button id="signInBtn" class="btn w-full flex items-center justify-center gap-3 bg-white text-slate-700 font-semibold px-4 py-3 border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50">
                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.618-3.417-11.284-8.066l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.99,35.508,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                <span>Masuk dengan Google</span>
            </button>
            <p id="auth-error" class="text-red-600 text-sm mt-4 hidden"></p>
        </div>
    </div>


    <!-- Main App Content (Initially Hidden) -->
    <div id="app-content" class="hidden">
        <div class="min-h-screen p-4 sm:p-6 lg:p-8">
            <div class="max-w-7xl mx-auto">
                
                <header class="mb-8">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h1 class="text-2xl sm:text-3xl font-bold text-[--color-primary]">Dashboard Asistensi Medis</h1>
                            <p class="text-slate-500 mt-1">Monitor dan kelola semua jadwal kegiatan.</p>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center gap-4 w-full sm:w-auto">
                             <div class="text-right">
                                <p id="userName" class="font-semibold text-slate-700"></p>
                                <button id="signOutBtn" class="text-sm text-red-600 hover:underline">Logout</button>
                             </div>
                            <button id="addScheduleBtn" class="btn flex items-center gap-2 bg-[--color-primary] text-white font-semibold px-5 py-2.5 rounded-lg shadow-md hover:bg-blue-900 w-full sm:w-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>Tambah Jadwal</span>
                            </button>
                        </div>
                    </div>
                </header>

                <div class="mb-6 bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                     <h3 class="font-semibold text-[--color-primary] mb-4 text-lg">Pencarian & Filter</h3>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="searchInput" placeholder="Cari berdasarkan nama pasien, rute..." class="form-input w-full px-4 py-2 border-[--color-bg-subtle] rounded-lg focus:outline-none focus:ring-2">
                        <select id="filterStatus" class="form-select w-full px-4 py-2 border-[--color-bg-subtle] rounded-lg focus:outline-none focus:ring-2">
                            <option value="">Semua Jenis Asistensi</option>
                            <option value="Ambulance Transfer">Ambulance Transfer</option>
                            <option value="Car Transfer">Car Transfer</option>
                            <option value="Home Visite">Home Visite</option>
                            <option value="Tarmac Access">Tarmac Access</option>
                            <option value="Medivac">Medivac</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                        <input type="date" id="filterDate" class="form-input w-full px-4 py-2 border-[--color-bg-subtle] rounded-lg focus:outline-none focus:ring-2">
                     </div>
                </div>
                
                <div class="mb-6 bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="font-semibold text-[--color-primary] mb-4 text-lg">Ekspor ke Excel</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="exportStartDate" class="block text-sm font-medium text-slate-700">Tanggal Mulai</label>
                            <input type="date" id="exportStartDate" class="form-input mt-1 w-full px-4 py-2 border-[--color-bg-subtle] rounded-lg focus:outline-none focus:ring-2">
                        </div>
                        <div>
                            <label for="exportEndDate" class="block text-sm font-medium text-slate-700">Tanggal Selesai</label>
                            <input type="date" id="exportEndDate" class="form-input mt-1 w-full px-4 py-2 border-[--color-bg-subtle] rounded-lg focus:outline-none focus:ring-2">
                        </div>
                        <button id="exportBtn" class="btn flex items-center justify-center gap-2 bg-[--color-accent] text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-[#a07103] h-11">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            <span>Ekspor</span>
                        </button>
                    </div>
                </div>

                <main class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-[--color-primary] uppercase bg-[--color-bg-subtle]/50">
                            <tr>
                                <th scope="col" class="px-4 py-4 sm:px-6 font-semibold">Pasien</th>
                                <th scope="col" class="px-4 py-4 sm:px-6 font-semibold">Tanggal & Waktu</th>
                                <th scope="col" class="px-4 py-4 sm:px-6 font-semibold">Jenis Asistensi</th>
                                <th scope="col" class="px-4 py-4 sm:px-6 font-semibold">Rute</th>
                                <th scope="col" class="px-4 py-4 sm:px-6 font-semibold">Petugas</th>
                                <th scope="col" class="px-4 py-4 sm:px-6 font-semibold">Total Fee</th>
                                <th scope="col" class="px-4 py-4 sm:px-6 font-semibold text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                             <tr id="emptyState" class="hidden">
                                <td colspan="7" class="text-center py-16">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--color-bg-subtle)" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                    <h3 class="font-semibold text-slate-700">Belum Ada Jadwal</h3>
                                    <p class="text-slate-500 mt-1">Klik "Tambah Jadwal" untuk memulai.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </main>
            </div>
        </div>

        <!-- Modals -->
        <div id="scheduleModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 hidden">
            <div class="modal-content bg-[--color-bg-light] rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <form id="scheduleForm" class="p-4 sm:p-8">
                    <input type="hidden" id="scheduleId">
                    <h2 id="modalTitle" class="text-xl sm:text-2xl font-bold mb-6 text-[--color-primary]">Tambah Jadwal Baru</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div class="md:col-span-2 text-lg font-semibold text-[--color-primary] border-b border-[--color-bg-subtle] pb-2 mb-2">Informasi Pasien</div>
                        <div>
                            <label for="patientName" class="block text-sm font-medium text-slate-700">Nama Pasien</label>
                            <input type="text" id="patientName" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="patientDob" class="block text-sm font-medium text-slate-700">Tanggal Lahir</label>
                            <input type="date" id="patientDob" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="patientGender" class="block text-sm font-medium text-slate-700">Jenis Kelamin</label>
                            <select id="patientGender" class="form-select mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                                <option value="">Pilih Jenis Kelamin</option>
                                <option value="Laki-laki">Laki-laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>
                         <div class="md:col-span-2">
                            <label for="patientAddress" class="block text-sm font-medium text-slate-700">Alamat Pasien</label>
                            <textarea id="patientAddress" rows="2" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm"></textarea>
                        </div>
                        <div class="md:col-span-2 text-lg font-semibold text-[--color-primary] border-b border-[--color-bg-subtle] pb-2 mt-4 mb-2">Detail Layanan</div>
                         <div>
                            <label for="referenceNumber" class="block text-sm font-medium text-slate-700">Nomor Referensi</label>
                            <input type="text" id="referenceNumber" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="insuranceClient" class="block text-sm font-medium text-slate-700">Klien Asuransi</label>
                            <select id="insuranceClient" class="form-select mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                                <option value="">Pilih Klien</option>
                                <option value="GAH">GAH</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div>
                            <label for="assistanceType" class="block text-sm font-medium text-slate-700">Jenis Asistensi Medis</label>
                            <select id="assistanceType" class="form-select mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                                <option value="">Pilih Jenis Layanan</option>
                                <option value="Ambulance Transfer">Ambulance Transfer</option>
                                <option value="Car Transfer">Car Transfer</option>
                                <option value="Home Visite">Home Visite</option>
                                <option value="Tarmac Access">Tarmac Access</option>
                                <option value="Medivac">Medivac</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div>
                            <label for="activityDate" class="block text-sm font-medium text-slate-700">Tanggal Kegiatan</label>
                            <input type="date" id="activityDate" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="activityTime" class="block text-sm font-medium text-slate-700">Waktu Pelaksanaan</label>
                            <input type="time" id="activityTime" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="serviceRoute" class="block text-sm font-medium text-slate-700">Rute Layanan</label>
                            <input type="text" id="serviceRoute" placeholder="Contoh: Klinik -> Bandara" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label for="serviceZone" class="block text-sm font-medium text-slate-700">Zona Layanan</label>
                            <select id="serviceZone" class="form-select mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                                <option value="">Pilih Zona</option>
                                <option value="Zona 1">Zona 1</option><option value="Zona 2">Zona 2</option><option value="Zona 3">Zona 3</option><option value="Zona 4">Zona 4</option><option value="Zona 5">Zona 5</option><option value="Zona 6">Zona 6</option><option value="Remote">Remote</option>
                            </select>
                        </div>
                         <div class="md:col-span-2 mt-2">
                            <div class="flex items-center">
                                <input id="extraMonitoring" type="checkbox" class="form-checkbox h-4 w-4 text-[--color-primary] border-gray-300 rounded">
                                <label for="extraMonitoring" class="ml-2 block text-sm text-slate-900">Perlu Monitoring Extra</label>
                            </div>
                        </div>
                        <div class="md:col-span-2 text-lg font-semibold text-[--color-primary] border-b border-[--color-bg-subtle] pb-2 mt-4 mb-2">Detail Petugas</div>
                        <div class="md:col-span-2" id="officersContainer"></div>
                        <div class="md:col-span-2">
                             <button type="button" id="addOfficerBtn" class="flex items-center gap-2 text-sm bg-blue-50 text-[--color-primary] font-semibold px-3 py-2 rounded-lg hover:bg-blue-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>Tambah Petugas</span>
                            </button>
                        </div>
                        <div id="freelanceBillingContainer" class="hidden md:col-span-2">
                             <label for="freelanceBillingDetails" class="block text-sm font-medium text-slate-700">Rincian Tagihan Freelance</label>
                            <textarea id="freelanceBillingDetails" rows="3" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm"></textarea>
                        </div>
                        <div class="md:col-span-2 text-lg font-semibold text-[--color-primary] border-b border-[--color-bg-subtle] pb-2 mt-4 mb-2">Finansial & Dokumen</div>
                        <div class="md:col-span-2">
                            <div class="flex items-center">
                                <input id="isComplete" type="checkbox" class="form-checkbox h-4 w-4 text-[--color-primary] border-gray-300 rounded">
                                <label for="isComplete" class="ml-2 block text-sm font-medium text-slate-900">Semua data sudah lengkap (sembunyikan dari dashboard)</label>
                            </div>
                        </div>
                        <div>
                            <label for="servicePrice" class="block text-sm font-medium text-slate-700">Harga Jaminan (Rp)</label>
                            <input type="number" id="servicePrice" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="invoicePrice" class="block text-sm font-medium text-slate-700">Harga Invoice (Rp)</label>
                            <input type="number" id="invoicePrice" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                        </div>
                        <div class="md:col-span-2"></div>
                        <div class="md:col-span-2">
                            <label for="invoiceLink" class="block text-sm font-medium text-slate-700">Link Invoice</label>
                            <input type="url" id="invoiceLink" placeholder="https://" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                        </div>
                         <div class="md:col-span-2">
                            <label for="medicalDocLink" class="block text-sm font-medium text-slate-700">Link Dok. Medis</label>
                            <input type="url" id="medicalDocLink" placeholder="https://" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label for="guaranteeLetterLink" class="block text-sm font-medium text-slate-700">Link Surat Jaminan</label>
                            <input type="url" id="guaranteeLetterLink" placeholder="https://" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                        </div>
                        <div id="medicalRecordLinkContainer" class="hidden md:col-span-2">
                            <label for="medicalRecordLink" class="block text-sm font-medium text-slate-700">Link Medical Record</label>
                            <input type="url" id="medicalRecordLink" placeholder="https://" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label for="otherNotes" class="block text-sm font-medium text-slate-700">Keterangan Lain</label>
                            <textarea id="otherNotes" rows="3" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm"></textarea>
                        </div>
                    </div>
                    <div id="formErrorMessage" class="text-red-600 text-sm mt-6 text-center font-medium hidden"></div>
                    <div class="flex items-center justify-end gap-4 mt-8 pt-6 border-t border-[--color-bg-subtle]">
                        <button type="button" id="cancelBtn" class="btn bg-gray-200 text-gray-800 font-semibold px-5 py-2.5 rounded-lg hover:bg-gray-300">Batal</button>
                        <button type="submit" class="btn bg-[--color-primary] text-white font-semibold px-5 py-2.5 rounded-lg shadow-md hover:bg-blue-900">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="customConfirm" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 hidden">
            <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-lg font-bold text-slate-900">Konfirmasi Hapus</h3>
                <p class="text-slate-600 mt-2">Yakin ingin hapus jadwal ini?</p>
                <div class="flex justify-end gap-3 mt-6">
                    <button id="confirmCancel" class="btn px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Batal</button>
                    <button id="confirmDelete" class="btn px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Hapus</button>
                </div>
            </div>
        </div>

        <div id="cardModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 hidden">
            <div class="modal-content bg-[--color-bg-light] rounded-xl shadow-2xl w-full max-w-md">
                <div class="p-6">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <h2 class="text-xl font-bold text-[--color-primary]">Kartu Informasi Layanan</h2>
                            <button id="editFromCardBtn" class="btn text-[--color-accent] hover:text-[#a07103] p-2 rounded-full hover:bg-yellow-100" title="Edit Jadwal"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                        </div>
                        <button id="closeCardBtn" class="text-slate-400 hover:text-slate-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                    </div>
                     <p id="cardAssistanceType" class="text-sm text-slate-500 mb-6"></p>
                    <div class="border-t border-[--color-bg-subtle] pt-6 space-y-4">
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase">Pasien</p>
                            <p id="cardPatientName" class="text-lg font-medium text-slate-800"></p>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase">Jenis Kelamin</p>
                            <p id="cardPatientGender" class="text-lg font-medium text-slate-800"></p>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase">Tgl Lahir / Umur</p>
                            <p id="cardPatientDobAndAge" class="text-lg font-medium text-slate-800"></p>
                        </div>
                         <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase">Alamat</p>
                            <p id="cardPatientAddress" class="text-base font-medium text-slate-800 whitespace-pre-wrap"></p>
                        </div>
                         <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase">Waktu Pelayanan</p>
                            <p id="cardActivityDateTime" class="text-lg font-medium text-slate-800"></p>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase">Rute</p>
                            <p id="cardServiceRoute" class="text-lg font-medium text-slate-800"></p>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase">Link Dok. Medis</p>
                            <div id="cardMedicalDocLink" class="text-lg font-medium text-slate-800"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<script type="module">
const mainApp = () => {
    const { db, collection, onSnapshot, addDoc, setDoc, deleteDoc, doc } = window.firebase;
    
    const scheduleCollection = collection(db, "schedules");
    
    const addScheduleBtn = document.getElementById('addScheduleBtn');
    const scheduleModal = document.getElementById('scheduleModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const scheduleForm = document.getElementById('scheduleForm');
    const scheduleTableBody = document.getElementById('scheduleTableBody');
    const modalTitle = document.getElementById('modalTitle');
    const scheduleIdInput = document.getElementById('scheduleId');
    const emptyState = document.getElementById('emptyState');
    const formErrorMessage = document.getElementById('formErrorMessage');
    const addOfficerBtn = document.getElementById('addOfficerBtn');
    const officersContainer = document.getElementById('officersContainer');
    const assistanceTypeSelect = document.getElementById('assistanceType');
    const freelanceBillingContainer = document.getElementById('freelanceBillingContainer');
    const medicalRecordLinkContainer = document.getElementById('medicalRecordLinkContainer');
    const extraMonitoringCheckbox = document.getElementById('extraMonitoring');
    const searchInput = document.getElementById('searchInput');
    const filterStatus = document.getElementById('filterStatus');
    const filterDate = document.getElementById('filterDate');
    const exportStartDateInput = document.getElementById('exportStartDate');
    const exportEndDateInput = document.getElementById('exportEndDate');
    const exportBtn = document.getElementById('exportBtn');
    const customConfirm = document.getElementById('customConfirm');
    const confirmCancel = document.getElementById('confirmCancel');
    const confirmDelete = document.getElementById('confirmDelete');
    let deleteResolver = null;
    const cardModal = document.getElementById('cardModal');
    const closeCardBtn = document.getElementById('closeCardBtn');
    const editFromCardBtn = document.getElementById('editFromCardBtn');

    let localSchedules = []; // Local cache of schedules
    const predefinedOfficerNames = ['dr. Agus', 'dr. Mitha', 'Eko', 'Ns. Dewi', 'Ns. Deliana', 'Ns. Komaliana', 'Ns. Ari', 'Ridwan'];

    const formatCurrency = (amount) => {
        if (amount === null || typeof amount === 'undefined' || amount === '' || isNaN(amount)) return 'N/A';
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    };
    
    const formatDate = (dateString) => {
        if (!dateString) return 'N/A';
        const date = new Date(dateString + 'T00:00:00');
        return date.toLocaleDateString('id-ID', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
    };

    const calculateAge = (dobString) => {
        if (!dobString) return null;
        const birthDate = new Date(dobString);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age;
    };
    
    const addOfficerRow = (officer = {}) => {
        const officerRow = document.createElement('div');
        officerRow.className = 'officer-row grid grid-cols-1 sm:grid-cols-6 gap-4 items-end';
        officerRow.dataset.auto = officer.auto || false;
        
        const isMonitoringOfficer = officer.name === 'Eko' && officer.auto;

        const selectOptions = predefinedOfficerNames.map(name => `<option value="${name}">${name}</option>`).join('');

        officerRow.innerHTML = `
            <div class="sm:col-span-2"><label class="block text-sm font-medium text-slate-700">Nama Petugas</label><select name="officerNameSelect" class="officer-name-select form-select mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm" ${isMonitoringOfficer ? 'disabled' : ''}><option value="">Pilih Petugas</option>${selectOptions}<option value="Lainnya">Lainnya</option></select><input type="text" name="officerNameText" class="officer-name-text form-input mt-2 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm hidden" placeholder="Masukkan nama petugas..."></div>
            <div><label class="block text-sm font-medium text-slate-700">Fee (Rp)</label><input type="number" name="officerFee" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm" value="${officer.fee || ''}" ${isMonitoringOfficer ? 'readonly' : ''}></div>
            <div><label class="block text-sm font-medium text-slate-700">Status</label><select name="officerStatus" class="officer-status-select form-select mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm" ${isMonitoringOfficer ? 'disabled' : ''}><option value="Staf" ${officer.status === 'Staf' ? 'selected' : ''}>Staf</option><option value="Freelance" ${officer.status === 'Freelance' ? 'selected' : ''}>Freelance</option></select></div>
            <div class="sm:col-span-2 flex items-center">${!isMonitoringOfficer ? `<button type="button" class="remove-officer-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="pointer-events: none;"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>` : '<div class="w-9 h-9"></div>'}</div>
            <div class="freelance-details hidden sm:col-span-6 grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                 <div><label class="block text-sm font-medium text-slate-700">Nama Bank</label><input type="text" name="bankName" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm" value="${officer.bankName || ''}"></div>
                 <div><label class="block text-sm font-medium text-slate-700">Nomor Rekening</label><input type="text" name="accountNumber" class="form-input mt-1 block w-full px-3 py-2 border border-[--color-bg-subtle] rounded-md shadow-sm" value="${officer.accountNumber || ''}"></div>
            </div>
        `;
        officersContainer.appendChild(officerRow);
        const nameSelect = officerRow.querySelector('[name="officerNameSelect"]');
        const nameText = officerRow.querySelector('[name="officerNameText"]');
        if (officer.name) {
            if (predefinedOfficerNames.includes(officer.name)) {
                nameSelect.value = officer.name;
            } else {
                nameSelect.value = 'Lainnya';
                nameText.value = officer.name;
                nameText.classList.remove('hidden');
            }
        }
        officerRow.querySelector('.remove-officer-btn')?.addEventListener('click', () => officerRow.remove());
        const statusSelect = officerRow.querySelector('.officer-status-select');
        statusSelect.addEventListener('change', handleOfficerStatusChange);
        nameSelect.addEventListener('change', (e) => {
            nameText.classList.toggle('hidden', e.target.value !== 'Lainnya');
            if(e.target.value !== 'Lainnya') nameText.value = '';
        });
        handleOfficerStatusChange({ target: statusSelect });
    };
    
    const handleOfficerStatusChange = (e) => {
        const status = e.target.value;
        const officerRow = e.target.closest('.officer-row');
        const freelanceDetails = officerRow.querySelector('.freelance-details');
        freelanceDetails.classList.toggle('hidden', status !== 'Freelance');
        checkFreelanceBillingVisibility();
    };
    
    const checkFreelanceBillingVisibility = () => {
        const serviceType = assistanceTypeSelect.value;
        const hasFreelancer = !!document.querySelector('.officer-status-select option[value="Freelance"]:checked');
        freelanceBillingContainer.classList.toggle('hidden', !(serviceType === 'Home Visite' && hasFreelancer));
    };

    const openModal = (modalElement) => modalElement.classList.remove('hidden');
    const closeModal = (modalElement) => modalElement.classList.add('hidden');
    
    const openConfirmDialog = () => {
        openModal(customConfirm);
        return new Promise(resolve => { deleteResolver = resolve; });
    };
    const closeConfirmDialog = () => {
        closeModal(customConfirm);
        deleteResolver = null;
    };
    confirmCancel.addEventListener('click', () => { if(deleteResolver) deleteResolver(false); closeConfirmDialog(); });
    confirmDelete.addEventListener('click', () => { if(deleteResolver) deleteResolver(true); closeConfirmDialog(); });

    const listenForSchedules = () => {
        onSnapshot(scheduleCollection, (snapshot) => {
            localSchedules = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTable();
        }, (error) => {
            console.error("Error listening for schedule updates:", error);
        });
    };
    
    const renderTable = () => {
        scheduleTableBody.innerHTML = '';
        const searchTerm = searchInput.value.toLowerCase();
        const statusFilter = filterStatus.value;
        const dateFilter = filterDate.value;
        const filteredSchedules = localSchedules.filter(schedule => {
            // Filter out completed schedules from dashboard view
            if (schedule.isComplete) {
                return false;
            }
            
            const officerNames = (schedule.officers || []).map(o => o.name.toLowerCase()).join(' ');
            const matchesSearch = searchTerm === '' ||
                (schedule.patientName && schedule.patientName.toLowerCase().includes(searchTerm)) ||
                (schedule.serviceRoute && schedule.serviceRoute.toLowerCase().includes(searchTerm)) ||
                officerNames.includes(searchTerm);
            const matchesStatus = statusFilter === '' || schedule.assistanceType === statusFilter;
            const matchesDate = dateFilter === '' || schedule.activityDate === dateFilter;
            return matchesSearch && matchesStatus && matchesDate;
        });

        if (filteredSchedules.length === 0) {
            emptyState.classList.remove('hidden');
            scheduleTableBody.appendChild(emptyState);
        } else {
            emptyState.classList.add('hidden');
            filteredSchedules.sort((a,b) => {
                const dateA = a.activityDate && a.activityTime ? new Date(`${a.activityDate}T${a.activityTime}`) : 0;
                const dateB = b.activityDate && b.activityTime ? new Date(`${b.activityDate}T${b.activityTime}`) : 0;
                return dateB - dateA;
            })
            .forEach(schedule => {
                const totalFee = (schedule.officers || []).reduce((sum, officer) => sum + (parseFloat(officer.fee) || 0), 0);
                const officerNames = (schedule.officers || []).map(o => o.name).join(', ');
                const row = document.createElement('tr');
                row.className = 'bg-white border-b border-gray-100 hover:bg-[--color-bg-subtle]/30';
                row.innerHTML = `
                    <td class="px-4 py-4 sm:px-6 font-medium text-slate-800 whitespace-nowrap">${schedule.patientName || '(Belum diisi)'}<div class="text-xs text-slate-500 font-normal">${formatDate(schedule.patientDob)}, ${schedule.patientGender || ''}</div></td>
                    <td class="px-4 py-4 sm:px-6">${formatDate(schedule.activityDate)}<div class="text-xs text-slate-500">${schedule.activityTime || ''}</div></td>
                    <td class="px-4 py-4 sm:px-6">${schedule.assistanceType || 'N/A'}</td>
                    <td class="px-4 py-4 sm:px-6">${schedule.serviceRoute || 'N/A'}</td>
                    <td class="px-4 py-4 sm:px-6 max-w-[150px] sm:max-w-xs truncate" title="${officerNames}">${officerNames || 'N/A'}</td>
                    <td class="px-4 py-4 sm:px-6 font-medium text-slate-800">${formatCurrency(totalFee)}</td>
                    <td class="px-4 py-4 sm:px-6 text-center"><div class="flex items-center justify-center gap-1 sm:gap-2">
                        <button class="card-btn text-green-600 p-2 rounded-full hover:bg-green-100" data-id="${schedule.id}" title="Tampilkan Kartu"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="pointer-events:none;"><path d="M19 4H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><circle cx="12" cy="10" r="3"/><path d="M12 13a5 5 0 0 0-5 5h10a5 5 0 0 0-5-5z"/></svg></button>
                        <button class="view-btn text-[--color-primary] p-2 rounded-full hover:bg-blue-100" data-id="${schedule.id}" title="Lihat Detail"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="pointer-events:none;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                        <button class="edit-btn text-[--color-accent] p-2 rounded-full hover:bg-yellow-100" data-id="${schedule.id}" title="Edit Jadwal"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="pointer-events:none;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                        <button class="delete-btn text-red-600 p-2 rounded-full hover:bg-red-100" data-id="${schedule.id}" title="Hapus Jadwal"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="pointer-events:none;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                    </div></td>
                `;
                scheduleTableBody.appendChild(row);
            });
        }
    };

    const resetForm = () => {
        scheduleForm.reset();
        scheduleIdInput.value = '';
        modalTitle.textContent = 'Tambah Jadwal Baru';
        officersContainer.innerHTML = '';
        formErrorMessage.classList.add('hidden');
        freelanceBillingContainer.classList.add('hidden');
        medicalRecordLinkContainer.classList.add('hidden');
    };

    const handleFormSubmit = async (e) => {
        e.preventDefault();
        formErrorMessage.classList.add('hidden'); 
        
        const officers = Array.from(officersContainer.querySelectorAll('.officer-row')).map(row => {
            const nameSelect = row.querySelector('[name="officerNameSelect"]');
            const nameText = row.querySelector('[name="officerNameText"]');
            const name = nameSelect.value === 'Lainnya' ? nameText.value : nameSelect.value;
            
            return { name, fee: row.querySelector('[name="officerFee"]').value, status: row.querySelector('[name="officerStatus"]').value, bankName: row.querySelector('[name="bankName"]').value, accountNumber: row.querySelector('[name="accountNumber"]').value, auto: row.dataset.auto === 'true' }
        });
        
        const id = scheduleIdInput.value;
        const scheduleData = {
            patientName: document.getElementById('patientName').value, patientDob: document.getElementById('patientDob').value, patientGender: document.getElementById('patientGender').value, patientAddress: document.getElementById('patientAddress').value, referenceNumber: document.getElementById('referenceNumber').value, insuranceClient: document.getElementById('insuranceClient').value, assistanceType: document.getElementById('assistanceType').value, activityDate: document.getElementById('activityDate').value, activityTime: document.getElementById('activityTime').value, serviceRoute: document.getElementById('serviceRoute').value, serviceZone: document.getElementById('serviceZone').value, extraMonitoring: document.getElementById('extraMonitoring').checked, officers: officers, freelanceBillingDetails: document.getElementById('freelanceBillingDetails').value, servicePrice: document.getElementById('servicePrice').value, invoicePrice: document.getElementById('invoicePrice').value, invoiceLink: document.getElementById('invoiceLink').value, medicalDocLink: document.getElementById('medicalDocLink').value, guaranteeLetterLink: document.getElementById('guaranteeLetterLink').value, medicalRecordLink: document.getElementById('medicalRecordLink').value, otherNotes: document.getElementById('otherNotes').value,
            isComplete: document.getElementById('isComplete').checked,
        };

        try {
            if (id) {
                const docRef = doc(db, "schedules", id);
                await setDoc(docRef, scheduleData);
            } else {
                await addDoc(scheduleCollection, scheduleData);
            }
            closeModal(scheduleModal);
        } catch (error) {
            console.error("Error saving document: ", error);
            formErrorMessage.textContent = "Gagal menyimpan data ke server.";
            formErrorMessage.classList.remove('hidden');
        }
    };
    
    const exportToExcel = () => {
        const startDate = exportStartDateInput.value;
        const endDate = exportEndDateInput.value;
        if (!startDate || !endDate) {
            alert('Silakan pilih periode tanggal.');
            return;
        }
        // For export, we use all localSchedules, ignoring the 'isComplete' flag
        const filtered = localSchedules.filter(s => s.activityDate >= startDate && s.activityDate <= endDate);
        if (filtered.length === 0) {
            alert('Tidak ada data pada periode yang dipilih.');
            return;
        }
        const dataForExport = filtered.map(s => ({
            'Status': s.isComplete ? 'Selesai' : 'Aktif',
            'No. Ref': s.referenceNumber, 'Klien': s.insuranceClient, 'Pasien': s.patientName, 'Tgl Lahir': s.patientDob, 'Gender': s.patientGender, 'Alamat': s.patientAddress, 'Jenis Asistensi': s.assistanceType, 'Tgl Kegiatan': s.activityDate, 'Waktu': s.activityTime, 'Rute': s.serviceRoute, 'Zona': s.serviceZone, 'Monitoring Extra': s.extraMonitoring ? 'Ya' : 'Tidak', 'Petugas': (s.officers || []).map(o => o.name).join(', '), 'Status Petugas': (s.officers || []).map(o => o.status).join(', '), 'Total Fee (Rp)': (s.officers || []).reduce((sum, o) => sum + (parseFloat(o.fee) || 0), 0), 'Rincian Fee': (s.officers || []).map(o => `${o.name}: ${formatCurrency(o.fee)}`).join('; '), 'Bank': (s.officers || []).filter(o=>o.status==='Freelance').map(o => `${o.name}: ${o.bankName || 'N/A'}`).join('; '), 'No. Rekening': (s.officers || []).filter(o=>o.status==='Freelance').map(o => `${o.name}: ${o.accountNumber || 'N/A'}`).join('; '), 'Tagihan Freelance': s.freelanceBillingDetails, 'Harga Jaminan (Rp)': s.servicePrice, 'Harga Invoice (Rp)': s.invoicePrice, 'Link Invoice': s.invoiceLink, 'Link Dok. Medis': s.medicalDocLink, 'Link Surat Jaminan': s.guaranteeLetterLink, 'Link Medical Record': s.medicalRecordLink, 'Catatan': s.otherNotes
        }));
        const worksheet = XLSX.utils.json_to_sheet(dataForExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Jadwal');
        const colWidths = Object.keys(dataForExport[0]).map(key => ({ wch: (dataForExport.reduce((max, row) => Math.max(max, (row[key] || '').length, key.length), 0)) + 2 }));
        worksheet['!cols'] = colWidths;
        XLSX.writeFile(workbook, `Jadwal_${startDate}_sd_${endDate}.xlsx`);
    };
    
    const openEditModal = (id) => {
        const schedule = localSchedules.find(s => s.id === id);
        if (schedule) {
            resetForm();
            modalTitle.textContent = 'Edit Jadwal';
            scheduleIdInput.value = schedule.id;
            Object.keys(schedule).forEach(key => {
                const input = document.getElementById(key);
                if(input) {
                    if(input.type === 'checkbox') input.checked = schedule[key];
                    else input.value = schedule[key];
                }
            });
            // Specifically handle the isComplete checkbox
            document.getElementById('isComplete').checked = schedule.isComplete || false;

            officersContainer.innerHTML = '';
            if (schedule.officers && schedule.officers.length > 0) {
                schedule.officers.forEach(officer => addOfficerRow(officer));
            } else {
                addOfficerRow();
            }
            assistanceTypeSelect.dispatchEvent(new Event('change'));
            openModal(scheduleModal);
        }
    };

    addScheduleBtn.addEventListener('click', () => { resetForm(); addOfficerRow(); openModal(scheduleModal); });
    cancelBtn.addEventListener('click', () => closeModal(scheduleModal));
    scheduleModal.addEventListener('click', (e) => { if (e.target === scheduleModal) closeModal(scheduleModal); });
    scheduleForm.addEventListener('submit', handleFormSubmit);
    addOfficerBtn.addEventListener('click', () => addOfficerRow());
    assistanceTypeSelect.addEventListener('change', () => {
        medicalRecordLinkContainer.classList.toggle('hidden', assistanceTypeSelect.value !== 'Home Visite');
        checkFreelanceBillingVisibility();
    });
    extraMonitoringCheckbox.addEventListener('change', (e) => {
        const existing = officersContainer.querySelector('.officer-row[data-auto="true"]');
        if (e.target.checked && !existing) {
            addOfficerRow({ name: 'Eko', fee: 75000, status: 'Staf', auto: true });
        } else if (!e.target.checked && existing) {
            existing.remove();
        }
    });

    scheduleTableBody.addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        const id = button.dataset.id;
        
        if (button.classList.contains('edit-btn')) {
            openEditModal(id);
        } else if (button.classList.contains('delete-btn')) {
            const confirmed = await openConfirmDialog();
            if (confirmed) {
                 await deleteDoc(doc(db, "schedules", id));
            }
        } else if (button.classList.contains('view-btn')) {
             const schedule = localSchedules.find(s => s.id === id);
             if(schedule) {
                let officerDetails = (schedule.officers || []).map(o => `  - ${o.name} (${o.status}, Fee: ${formatCurrency(o.fee)})` + (o.status === 'Freelance' ? ` | Bank: ${o.bankName} - ${o.accountNumber}`: '')).join('\n');
                alert(`DETAIL JADWAL\n--------------------------------------\nNo. Ref: ${schedule.referenceNumber||'N/A'}\nKlien: ${schedule.insuranceClient||'N/A'}\nPasien: ${schedule.patientName} (${formatDate(schedule.patientDob)}, ${schedule.patientGender})\nAlamat: ${schedule.patientAddress||'N/A'}\n--------------------------------------\nLayanan: ${schedule.assistanceType} | Zona: ${schedule.serviceZone||'N/A'}\nTanggal: ${formatDate(schedule.activityDate)} @ ${schedule.activityTime}\nRute: ${schedule.serviceRoute||'N/A'}\nMonitoring Extra: ${schedule.extraMonitoring?'Ya':'Tidak'}\nStatus: ${schedule.isComplete ? 'Selesai':'Aktif'}\n--------------------------------------\nPetugas:\n${officerDetails}\n--------------------------------------\nHarga Jaminan: ${formatCurrency(schedule.servicePrice)}\nHarga Invoice: ${formatCurrency(schedule.invoicePrice)}\n--------------------------------------\nTagihan Freelance: ${schedule.freelanceBillingDetails||'N/A'}\nCatatan Lain: ${schedule.otherNotes||'N/A'}`);
             }
        } else if (button.classList.contains('card-btn')) {
            const schedule = localSchedules.find(s => s.id === id);
            if (schedule) {
                cardModal.dataset.id = schedule.id;
                document.getElementById('cardAssistanceType').textContent = schedule.assistanceType || 'N/A';
                document.getElementById('cardPatientName').textContent = schedule.patientName || 'N/A';
                document.getElementById('cardPatientGender').textContent = schedule.patientGender || 'N/A';
                document.getElementById('cardPatientAddress').textContent = schedule.patientAddress || 'Tidak ada';
                document.getElementById('cardServiceRoute').textContent = schedule.serviceRoute || 'N/A';
                const age = calculateAge(schedule.patientDob);
                const ageText = age !== null ? `(${age} tahun)` : '';
                document.getElementById('cardPatientDobAndAge').textContent = `${formatDate(schedule.patientDob)} ${ageText}`;
                document.getElementById('cardActivityDateTime').textContent = `${formatDate(schedule.activityDate)} pukul ${schedule.activityTime || ''}`;
                const linkContainer = document.getElementById('cardMedicalDocLink');
                if (schedule.medicalDocLink) {
                    linkContainer.innerHTML = `<a href="${schedule.medicalDocLink}" target="_blank" class="text-[--color-primary] hover:underline break-all">${schedule.medicalDocLink}</a>`;
                } else {
                    linkContainer.textContent = 'Tidak ada';
                }
                openModal(cardModal);
            }
        }
    });
    
    searchInput.addEventListener('input', renderTable);
    filterStatus.addEventListener('change', renderTable);
    filterDate.addEventListener('change', renderTable);
    exportBtn.addEventListener('click', exportToExcel);
    closeCardBtn.addEventListener('click', () => closeModal(cardModal));
    cardModal.addEventListener('click', (e) => { if (e.target === cardModal) closeModal(cardModal); });
    editFromCardBtn.addEventListener('click', () => {
        const id = cardModal.dataset.id;
        if (id) {
            closeModal(cardModal);
            openEditModal(id);
        }
    });

    listenForSchedules(); // Start listening for real-time updates
};


document.addEventListener('DOMContentLoaded', () => {
    const { auth, db, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, doc, getDoc } = window.firebase;

    const loginOverlay = document.getElementById('login-overlay');
    const appContent = document.getElementById('app-content');
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const authError = document.getElementById('auth-error');
    const userNameDisplay = document.getElementById('userName');

    const provider = new GoogleAuthProvider();
    
    const showLogin = () => {
        loginOverlay.classList.remove('hidden');
        appContent.classList.add('hidden');
    };

    const showApp = (user) => {
        loginOverlay.classList.add('hidden');
        appContent.classList.remove('hidden');
        userNameDisplay.textContent = user.displayName || user.email;
        mainApp();
    };

    const checkAuthorization = async (user) => {
        if (!user) {
            showLogin();
            return;
        }
        
        try {
            const userDocRef = doc(db, "authorizedUsers", user.email);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                showApp(user);
            } else {
                authError.textContent = 'Akses ditolak. Email Anda tidak terdaftar.';
                authError.classList.remove('hidden');
                await signOut(auth);
            }
        } catch (error) {
            console.error("Error checking authorization:", error);
            authError.textContent = 'Gagal verifikasi. Coba lagi.';
            authError.classList.remove('hidden');
            await signOut(auth);
        }
    };
    
    signInBtn.addEventListener('click', async () => {
        authError.classList.add('hidden');
        try {
            await signInWithPopup(auth, provider);
        } catch (error) {
            console.error("Google Sign-In Error:", error);
            authError.textContent = 'Gagal masuk. Silakan coba lagi.';
            authError.classList.remove('hidden');
        }
    });

    signOutBtn.addEventListener('click', async () => {
        await signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
        if (user) {
            checkAuthorization(user);
        } else {
            showLogin();
        }
    });
});
</script>

</body>
</html>

